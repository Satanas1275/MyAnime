<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lecteur Anime</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; padding: 10px; }
    iframe { width: 100%; height: 400px; border: none; background: #000; }
    #logbox { white-space: pre-wrap; font-family: monospace; background: #222; padding: 10px; margin-top: 10px; max-height: 300px; overflow-y: auto; border: 1px solid #444; }
  </style>
</head>
<body>

<h2>Lecteur Anime</h2>
<iframe id="player" src=""></iframe>

<div id="logbox">[ Logs chargement... ]</div>

<script>
const LOG_BOX = document.getElementById("logbox");
const PLAYER = document.getElementById("player");

const getParam = (key) => {
  const url = new URL(location.href);
  return url.searchParams.get(key);
};

const log = (msg) => {
  if (LOG_BOX) LOG_BOX.textContent += "\nâ†’ " + msg;
  else console.log(msg);
};

const normalizeSlug = async (animeSlug) => {
  try {
    const res = await fetch("https://satanas1275.github.io/MyAnime/assets/slugs.json");
    const map = await res.json();
    return map[animeSlug] || animeSlug;
  } catch (e) {
    log("âš ï¸ Erreur chargement du JSON de correction de slug");
    return animeSlug;
  }
};

const tryLoadEpisodes = async (slug, langList) => {
  for (const lang of langList) {
    const url = `https://corsproxy.io/?https://anime-sama.fr/catalogue/${slug}/saison1/${lang}/episodes.js`;
    log("ğŸ”„ Chargement de: " + url);

    try {
      const res = await fetch(url);
      const text = await res.text();

      if (!text.includes("var eps")) continue;

      log("ğŸ“¦ Script rÃ©cupÃ©rÃ©, parsing Ã  la main...");
      const found = {};

      // Extraction brute des tableaux
      for (let i = 1; i <= 4; i++) {
        const match = text.match(new RegExp(`var eps${i}\\s*=\\s*\\[(.*?)\\];`, 's'));
        if (!match) {
          log(`âš ï¸ eps${i} introuvable`);
          continue;
        }

        try {
          const cleaned = `[${match[1].replace(/[\n\r\s]+/g, "").replace(/,+/g, ",").replace(/,\]/g, "]")}]`;
          const urls = JSON.parse(cleaned.replace(/'/g, '"'));
          found[`eps${i}`] = urls;
          for (let j = 0; j < urls.length; j++) {
            log(`âœ… eps${i} - Ã©pisode ${j + 1} trouvÃ©`);
          }
        } catch (e) {
          log(`âš ï¸ JSON parse Ã©chouÃ© pour eps${i}: ${e.message}`);
        }
      }

      const total = Object.values(found).reduce((acc, list) => acc + list.length, 0);
      if (total === 0) {
        log("âŒ Erreur: Aucun Ã©pisode valide trouvÃ©");
        return;
      }

      log(`âœ… ${total} Ã©pisode(s) chargÃ©(s).`);
      const first = Object.values(found).flat()[0];
      if (first) {
        log("â–¶ï¸ Lecture auto du premier Ã©pisode");
        PLAYER.src = first;
      }

      return; // STOP si un fichier a Ã©tÃ© trouvÃ© et lu
    } catch (e) {
      log("âŒ Erreur chargement: " + e.message);
    }
  }

  log("âŒ Aucun fichier episodes.js trouvÃ©. Pour Ã©viter ce bug, utilise le JSON de correction de slug.");
};

(async () => {
  const rawSlug = (getParam("V") || "").trim().toLowerCase();
  const langList = (getParam("lang") || "vostfr,vf").split(",").map(l => l.trim().toLowerCase()).filter(Boolean);

  const fixedSlug = await normalizeSlug(rawSlug);
  log("ğŸ¯ Anime corrigÃ© : " + fixedSlug);
  log("ğŸˆ¯ï¸ Langues prioritaires : " + langList.join(", "));

  await tryLoadEpisodes(fixedSlug, langList);
})();
</script>

</body>
</html>
