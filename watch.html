<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>MyAnime Watch</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; text-align: center; }
    select, iframe { margin: 10px; padding: 10px; }
  </style>
</head>
<body>

  <h1 id="anime-title">Chargement...</h1>
  <div id="episodes-container"></div>
  <iframe id="player" width="100%" height="480" frameborder="0" allowfullscreen></iframe>

  <script>
    const params = new URLSearchParams(location.search);
    const slug = params.get('V');
    const lang = params.get('lang') || 'vf';

    const base = `https://anime-sama.fr/catalogue/${slug}`;
    const cors = "https://corsproxy.io/?";
    const episodeContainer = document.getElementById("episodes-container");
    const player = document.getElementById("player");
    document.getElementById("anime-title").innerText = decodeURIComponent(slug.replace(/-/g, " "));

    async function tryLoadEpisodes(type = "saison1") {
      const url = `${base}/${type}/${lang}/episodes.js`;
      const fullUrl = cors + url;

      try {
        const res = await fetch(fullUrl);
        const jsCode = await res.text();

        // Interpréter le contenu du fichier JS (ex: `var episodes = [...]`)
        const sandbox = {};
        new Function("window", jsCode)(sandbox);
        const episodes = sandbox.episodes || window.episodes;

        if (!episodes || episodes.length === 0) throw new Error("Pas d'épisodes");

        renderEpisodes(episodes);
      } catch (e) {
        if (type === "saison1") return tryLoadEpisodes("film");
        else episodeContainer.innerText = "Impossible de charger les épisodes.";
      }
    }

    function renderEpisodes(episodes) {
      const select = document.createElement("select");
      select.innerHTML = episodes.map((ep, i) => `<option value="${ep.url}">Épisode ${i + 1}</option>`).join("");
      select.onchange = () => player.src = select.value;
      episodeContainer.appendChild(select);

      // Charger premier épisode par défaut
      player.src = episodes[0].url;
    }

    // Charger le script vidéos global
    const scriptVideo = document.createElement("script");
    scriptVideo.src = cors + "https://anime-sama.fr/js/contenu/script_videos.js?filever=25309";
    scriptVideo.defer = true;
    document.body.appendChild(scriptVideo);

    // Charger les épisodes
    tryLoadEpisodes();
  </script>

</body>
</html>
