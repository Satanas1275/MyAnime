<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>MyAnime Watch</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; text-align: center; margin: 0; padding: 1rem; }
    select, iframe { margin: 10px; padding: 10px; }
    #log {
      background: #222;
      color: #0f0;
      text-align: left;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 2rem;
      padding: 1rem;
      border-top: 1px solid #444;
    }
  </style>
</head>
<body>

  <h1 id="anime-title">Chargement...</h1>
  <div id="episodes-container"></div>
  <iframe id="player" width="100%" height="480" frameborder="0" allowfullscreen></iframe>

  <div id="log">[Logs]<br></div>

  <script>
    const logBox = document.getElementById("log");
    function log(msg) {
      logBox.innerHTML += msg + "<br>";
      logBox.scrollTop = logBox.scrollHeight;
    }

    const params = new URLSearchParams(location.search);
    const slug = params.get('V');
    const lang = params.get('lang') || 'vf';

    const base = `https://anime-sama.fr/catalogue/${slug}`;
    const cors = "https://corsproxy.io/?";
    const episodeContainer = document.getElementById("episodes-container");
    const player = document.getElementById("player");
    document.getElementById("anime-title").innerText = decodeURIComponent(slug.replace(/-/g, " "));

    async function tryLoadEpisodes(type = "saison1") {
      const url = `${base}/${type}/${lang}/episodes.js`;
      const fullUrl = cors + url;
      log(`üîÑ Tentative chargement: ${fullUrl}`);

      try {
        const res = await fetch(fullUrl);
        const jsCode = await res.text();

        log("üì¶ Script r√©cup√©r√©. Ex√©cution...");

        // Interpr√©ter le contenu JS dans un scope isol√©
        const sandbox = {};
        new Function("window", jsCode)(sandbox);

        const episodes = sandbox.episodes || window.episodes;
        log(`‚úÖ ${episodes?.length || 0} √©pisode(s) d√©tect√©(s).`);

        if (!episodes || episodes.length === 0) throw new Error("Pas d'√©pisodes");

        renderEpisodes(episodes);
      } catch (e) {
        log(`‚ùå Erreur chargement depuis ${type}: ${e.message}`);
        if (type === "saison1") return tryLoadEpisodes("film");
        else episodeContainer.innerText = "Impossible de charger les √©pisodes.";
      }
    }

    function renderEpisodes(episodes) {
      const select = document.createElement("select");
      select.innerHTML = episodes.map((ep, i) => `<option value="${ep.url}">√âpisode ${i + 1}</option>`).join("");
      select.onchange = () => {
        log(`üé¨ Lecture: ${select.value}`);
        player.src = select.value;
      };
      episodeContainer.appendChild(select);
      player.src = episodes[0].url;
      log(`üé¨ Lecture auto: ${episodes[0].url}`);
    }

    // Charger script vid√©o principal
    const scriptVideo = document.createElement("script");
    scriptVideo.src = cors + "https://anime-sama.fr/js/contenu/script_videos.js?filever=25309";
    scriptVideo.defer = true;
    document.body.appendChild(scriptVideo);
    log("üìÅ Script vid√©os global inject√©.");

    // Lancer le chargement des √©pisodes
    tryLoadEpisodes();
  </script>

</body>
</html>
