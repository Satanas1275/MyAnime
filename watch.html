<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lecteur Anime-sama</title>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: sans-serif;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    #logs {
      background: #1e1e1e;
      color: #aaa;
      font-family: monospace;
      font-size: 0.8rem;
      padding: 0.5rem;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    #episodes {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .episode-btn {
      background-color: #2c2c2c;
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }
    iframe {
      width: 100%;
      height: 480px;
      border: none;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>Lecteur Anime-sama</h1>
  <div id="logs">[ Logs chargement... ]</div>
  <div id="episodes">Chargement des √©pisodes...</div>
  <iframe id="videoPlayer" allowfullscreen></iframe>

  <script>
    const logBox = document.getElementById("logs");
    const episodeContainer = document.getElementById("episodes");
    const videoPlayer = document.getElementById("videoPlayer");

    function log(msg) {
      logBox.innerHTML += `‚Üí ${msg}<br>`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    const params = new URLSearchParams(window.location.search);
    const anime = params.get("V");
    const lang = params.get("lang") || "vf";

    if (!anime) {
      log("‚ùå Aucun nom d'anime sp√©cifi√© dans l'URL.");
      episodeContainer.innerText = "Erreur: Aucun anime pr√©cis√©.";
      throw new Error("Anime manquant");
    }

    const base = `https://anime-sama.fr/catalogue/${anime}`;
    const cors = "https://corsproxy.io/?";

    async function tryLoadEpisodes(type = "saison1") {
      const url = `${base}/${type}/${lang}/episodes.js`;
      const fullUrl = cors + url;
      log(`üîÑ Chargement de: ${fullUrl}`);

      try {
        const res = await fetch(fullUrl);
        const jsCode = await res.text();

        log("üì¶ Script r√©cup√©r√©, parsing √† la main...");

        const regex = /var\s+eps(\d+)\s*=\s*\[(.*?)\];/gs;
        const episodes = [];

        let match;
        while ((match = regex.exec(jsCode)) !== null) {
          const index = parseInt(match[1]);
          const arrayContent = match[2]
            .replace(/[\r\n\t]/g, '') // remove newlines, tabs
            .trim()
            .replace(/,\s*$/, ''); // remove trailing comma

          try {
            const jsonArray = JSON.parse(`[${arrayContent}]`);
            if (jsonArray.length > 0) {
              episodes[index - 1] = { url: jsonArray[0], index };
              log(`‚úÖ √âpisode ${index} trouv√©.`);
            }
          } catch (e) {
            log(`‚ö†Ô∏è JSON parse √©chou√© pour eps${index}: ${e.message}`);
          }
        }

        if (episodes.length === 0) throw new Error("Aucun √©pisode valide trouv√©");

        log(`‚úÖ ${episodes.length} √©pisode(s) charg√©(s).`);
        renderEpisodes(episodes);
      } catch (err) {
        log(`‚ùå Erreur: ${err.message}`);
        if (type === "saison1") return tryLoadEpisodes("film");
        episodeContainer.innerText = "Impossible de charger les √©pisodes.";
      }
    }

    function renderEpisodes(episodes) {
      episodeContainer.innerHTML = "";
      episodes.forEach(ep => {
        if (!ep) return;
        const btn = document.createElement("button");
        btn.className = "episode-btn";
        btn.textContent = `√âpisode ${ep.index}`;
        btn.onclick = () => {
          videoPlayer.src = ep.url;
          log(`üé¨ Lecture √©pisode ${ep.index}`);
        };
        episodeContainer.appendChild(btn);
      });

      // Lecture automatique du premier
      const first = episodes.find(e => e);
      if (first) {
        videoPlayer.src = first.url;
        log("‚ñ∂Ô∏è Lecture auto du premier √©pisode");
      }
    }

    tryLoadEpisodes();
  </script>
</body>
</html>
