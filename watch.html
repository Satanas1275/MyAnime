<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>MyAnime Watch</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      text-align: center;
      margin: 0;
      padding: 1rem;
    }
    select, iframe {
      margin: 10px;
      padding: 10px;
    }
    #log {
      background: #222;
      color: #0f0;
      text-align: left;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 2rem;
      padding: 1rem;
      border-top: 1px solid #444;
    }
  </style>
</head>
<body>

  <h1 id="anime-title">Chargement...</h1>
  <div id="episodes-container">Chargement des √©pisodes...</div>
  <iframe id="player" width="100%" height="480" frameborder="0" allowfullscreen></iframe>

  <div id="log">[Logs]<br></div>

  <script>
    const logBox = document.getElementById("log");
    function log(msg) {
      logBox.innerHTML += msg + "<br>";
      logBox.scrollTop = logBox.scrollHeight;
    }

    const params = new URLSearchParams(location.search);
    const slug = params.get('V');
    const lang = params.get('lang') || 'vf';

    const base = `https://anime-sama.fr/catalogue/${slug}`;
    const cors = "https://corsproxy.io/?";
    const episodeContainer = document.getElementById("episodes-container");
    const player = document.getElementById("player");
    document.getElementById("anime-title").innerText = decodeURIComponent(slug.replace(/-/g, " "));

    async function tryLoadEpisodes(type = "saison1") {
      const url = `${base}/${type}/${lang}/episodes.js`;
      const fullUrl = cors + url;
      log(`üîÑ Chargement de: ${fullUrl}`);

      try {
        const res = await fetch(fullUrl);
        const jsCode = await res.text();

        log("üì¶ Script r√©cup√©r√©, parsing en cours...");

        const sandbox = {};
        new Function("sandbox", `
          with(sandbox) {
            ${jsCode}
          }
        `)(sandbox);

        const episodes = [];

        // Parcourir toutes les cl√©s eps1, eps2, eps3...
        for (let key in sandbox) {
          if (key.startsWith("eps") && Array.isArray(sandbox[key])) {
            const index = parseInt(key.replace("eps", ""));
            const urls = sandbox[key];
            urls.forEach(url => {
              episodes[index - 1] = { url, index };
            });
          }
        }

        if (episodes.length === 0) throw new Error("Aucun √©pisode trouv√©");

        log(`‚úÖ ${episodes.length} √©pisode(s) charg√©(s).`);
        renderEpisodes(episodes);
      } catch (err) {
        log(`‚ùå Erreur: ${err.message}`);
        if (type === "saison1") return tryLoadEpisodes("film");
        episodeContainer.innerText = "Impossible de charger les √©pisodes.";
      }
    }

    function renderEpisodes(episodes) {
      episodeContainer.innerHTML = "";

      const select = document.createElement("select");
      select.innerHTML = episodes.map(ep =>
        `<option value="${ep.url}">√âpisode ${ep.index}</option>`
      ).join("");

      select.onchange = () => {
        const url = select.value;
        log(`üé¨ Lecture: ${url}`);
        player.src = url;
      };

      episodeContainer.appendChild(select);
      player.src = episodes[0].url;
      log(`üé¨ Lecture auto: ${episodes[0].url}`);
    }

    // Charger le script global vid√©os
    const scriptVideo = document.createElement("script");
    scriptVideo.src = cors + "https://anime-sama.fr/js/contenu/script_videos.js?filever=25309";
    scriptVideo.defer = true;
    document.body.appendChild(scriptVideo);
    log("üìÅ Script vid√©os global inject√©.");

    tryLoadEpisodes();
  </script>

</body>
</html>
